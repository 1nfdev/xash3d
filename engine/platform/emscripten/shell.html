<!doctype html>
<html lang="en-us">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<meta name="MobileOptimized" content="640"/>
		<meta name="HandheldFriendly" content="true"/>
		<title>Xash3D Emscripten Port</title>
		<style>
		  body {
			font-family: arial;
			margin: 0;
			padding: none;
		  }

		  .emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
		  div.emscripten { text-align: center; }
		  div.emscripten_border { border: 1px solid black; }
		  /* the canvas *must not* have any border or padding, or mouse coords will be wrong */
		  canvas.emscripten { border: 0px none; background-color: black; }

		  @-webkit-keyframes rotation {
			from {-webkit-transform: rotate(0deg);}
			to {-webkit-transform: rotate(360deg);}
		  }
		  @-moz-keyframes rotation {
			from {-moz-transform: rotate(0deg);}
			to {-moz-transform: rotate(360deg);}
		  }
		  @-o-keyframes rotation {
			from {-o-transform: rotate(0deg);}
			to {-o-transform: rotate(360deg);}
		  }
		  @keyframes rotation {
			from {transform: rotate(0deg);}
			to {transform: rotate(360deg);}
		  }


		  #controls {
			display: inline-block;
			float: right;
			vertical-align: top;
			margin-top: 30px;
			margin-right: 20px;
		  }

		  #output {
			width: 100%;
			height: 200px;
			margin: 0 auto;
			margin-top: 10px;
			border-left: 0px;
			border-right: 0px;
			padding-left: 0px;
			padding-right: 0px;
			display: block;
			background-color: black;
			color: white;
			font-family: 'Lucida Console', Monaco, monospace;
			outline: none;
		  }
		</style>
	</head>
	<body>
		<div class="emscripten_border">
			<canvas style="display:none" class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
		</div>


		<div style="float:left;" id="status">Downloading...</div>
			<span id='controls'>
				<span><input type="checkbox" id="resize">Resize canvas</span>
				<span><input type="checkbox" id="pointerLock" checked>Lock/hide mouse pointer &nbsp;&nbsp;&nbsp;</span>
				<span><input type="button" value="Fullscreen" onclick="Module.requestFullscreen(document.getElementById('pointerLock').checked, document.getElementById('resize').checked)">
			</span>
		</span>



		<textarea id="output" rows="8"></textarea><div  id="asyncDialog" style="float:left"></div>
		<form style=display:none id=fSettings>Select filesystem for settings and saverestore:<br>
			<div id=idbHider style=display:none><input name=a type=radio id=rIndexedDB />IndexedDB (Need exit correctly to save changes)<br></div>
			<input name=a type=radio id=rLocalStorage />LocalStorage (Sometimes not enough space)<br>
			<input name=a type=radio id=rNone checked=true />None(in RAM)<br>
			Select game data source:<br>
			<input name=b type=radio id=rPackage checked=true />Emscripten package from server (cached in IndexedDB if availiable)<br>
			<input name=b type=radio id=rZip />ZIP archive from server (slower, but smaller, no IndexedDB cache: <a href='hldm.zip'>hldm.zip</a>)<br>
			<input name=b type=radio id=rLocalZip  />Local ZIP file:<input type=file name=c id=iZipFile /><br>
			Command-line arguments: <input name=d type=text id=iArgs /><br>

			<input type=button onclick="startXash();return false;" value="Launch Xash3D" />
		</form>

		<script type='text/javascript' src='browserfs.min.js'></script>

		<script type='text/javascript'>
		var statusElement = document.getElementById('status');
		var asyncDialog = document.getElementById('asyncDialog');
		var myerrorbuf = ''
		var myerrordate = new Date();
		var mounted = false;
		var gamedir = 'valve';
		var xashdir = 'xash';
		var moduleCount = 0;
		var mem = 150;
		var emscriptenPackageName = 'hldm.js';
		var zipFileName = 'hldm.zip';

		try{mem = Math.round(window.location.hash.substring(1));}catch(e){};

		var Module = {
			TOTAL_MEMORY: mem * 1024 * 1024,
			preRun: [],
			postRun: [],
			print: (function() {
				var element = document.getElementById('output');
				if (element) element.value = ''; // clear browser cache
				return function(text) {
					if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
					// These replacements are necessary if you render to raw HTML
					//text = text.replace(/&/g, "&amp;");
					//text = text.replace(/</g, "&lt;");
					//text = text.replace(/>/g, "&gt;");
					//text = text.replace('\n', '<br>', 'g');
					//console.log(text);
					if(text)
						myerrorbuf += text + '\n';
					if (element) {
						if(element.value.length > 65536)
							element.value = element.value.substring(512) + myerrorbuf;
						else
							element.value += myerrorbuf;
						element.scrollTop = element.scrollHeight; // focus on bottom
					}
					myerrorbuf = ''
				};
			})(),
			printErr: function(text) {
				if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
				if (0) { // XXX disabled for safety typeof dump == 'function') {
					dump(text + '\n'); // fast, straight to the real console
				} else {
					if( myerrorbuf.length > 2048 )
					myerrorbuf = 'some lines skipped\n'+ myerrorbuf.substring(512);
					myerrorbuf += text + '\n';
					if(  new Date() - myerrordate > 3000 )
					{
						myerrordate = new Date();
						Module.print();
					}
				}
			},
			canvas: (function() {
				var canvas = document.getElementById('canvas');

				// As a default initial behavior, pop up an alert when webgl context is lost. To make your
				// application robust, you may want to override this behavior before shipping!
				// See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
				canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);

				return canvas;
			})(),
			setStatus: function(text) {
				if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
				if (text === Module.setStatus.text) return;
				if(  new Date() - myerrordate > 3000 )
				{
					myerrordate = new Date();
					Module.print();
				}

				statusElement.innerHTML = text;
			},
			totalDependencies: 0,
			monitorRunDependencies: function(left) {
				this.totalDependencies = Math.max(this.totalDependencies, left);
				if(left)
					Module.setStatus('Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')');
			}
		};
		Module.setStatus('Downloading...');
		window.onerror = function(event) {
		if( (''+event).indexOf('SimulateInfiniteLoop') > 0 )
			return;
		var text = 'Exception thrown: ' + event;
		text = text.replace(/&/g, "&amp;");
		text = text.replace(/</g, "&lt;");
		text = text.replace(/>/g, "&gt;");
		text = text.replace('\n', '<br>', 'g');
		Module.setStatus(text);
		Module.print('Exception thrown: ' + event);
		if(mounted)
		FS.syncfs(false,function(err){Module.print('Saving IDBFS: '+err);});
		};

		function haltRun()
		{
		}

		var savedRun;

		function radioChecked(id)
		{
			var r = document.getElementById('r'+id);
			if(r) return r.checked;
			return false;
		}
		function showElement(id, show)
		{
			var e = document.getElementById(id);
			if(!e) return;
			e.style.display=show?'block':'none';
		}
		function startXash()
		{
			showElement('fSettings', false);
			setupFS();
			Module.arguments = document.getElementById('iArgs').value.split(' ');
			Module.run = run = savedRun;
			if( radioChecked('Zip') )
				fetchZIP(zipFileName, savedRun);
			else if( radioChecked('LocalZip') )
			{
			var reader = new FileReader();
				reader.onload = function(){
					mountZIP(reader.result);
					Module.print("Loaded zip data");
					savedRun();
				};
				reader.readAsArrayBuffer(document.getElementById('iZipFile').files[0]);
			}
			else if( radioChecked('Package') )
			{
			  var script = document.createElement('script');
			  script.onload = savedRun;
			  document.body.appendChild(script);
			  script.src = emscriptenPackageName;
			}
			showElement('canvas', true);

			window.addEventListener("beforeunload", function (e) {
				var confirmationMessage = 'Leave the game?';

				(e || window.event).returnValue = confirmationMessage; //Gecko + IE
				return confirmationMessage; //Gecko + Webkit, Safari, Chrome etc.
			});

		}
		function mountZIP(data)
		{
			var Buffer = BrowserFS.BFSRequire('buffer').Buffer;
			BrowserFS.initialize(new BrowserFS.FileSystem.ZipFS(Buffer.from(data)));
			FS.mount(new BrowserFS.EmscriptenFS(), {root:'/'}, '/rodir');
		}
		function fetchZIP(packageName, cb)
		{
			var xhr = new XMLHttpRequest();
			xhr.open('GET', packageName, true);
			xhr.responseType = 'arraybuffer';

			xhr.onprogress = function(event) {
				var url = packageName;
				var size = 60000000;
				if (event.total) size = event.total;
				if (event.loaded) {
					var total = size;
					var loaded = event.loaded;
					var num = 0;
					if (Module['setStatus']) Module['setStatus']('Downloading data... (' + loaded + '/' + total + ')');
				} else if (!Module.dataFileDownloads) {
					if (Module['setStatus']) Module['setStatus']('Downloading data...');
				}
			};
			xhr.onerror = function(event) {
				throw new Error("NetworkError");
			}
			xhr.onload = function(event) {
				if (xhr.status == 200 || xhr.status == 304 || xhr.status == 206 || (xhr.status == 0 && xhr.response)) { // file URLs can return 0
					mountZIP(xhr.response);
					cb();
				} else {
					throw new Error(xhr.statusText + " : " + xhr.responseURL);
				}
			};
			xhr.send(null);

		}
		function setupFS()
		{
			FS.mkdir('/rodir');
			FS.mkdir(xashdir);

			if( radioChecked('IndexedDB'))
			{
				FS.mount(IDBFS,{},'/'+xashdir);
				FS.syncfs(true,function(err){if(err)Module.print('Loading IDBFS: ' + err);else updategameinfo() });
				mounted = true;
			}
			if( radioChecked('LocalStorage'))
			{
				BrowserFS.initialize(new BrowserFS.FileSystem.LocalStorage());
				FS.mount(new BrowserFS.EmscriptenFS(), {root:'/'}, '/'+xashdir);
				Module.print('LocalStorage mounted');
			}
			FS.chdir('/xash/');
		}
		function skipRun()
		{
			savedRun = run;
			Module.run = haltRun;
			run = haltRun;
			Module.setStatus("Engine downloaded!");
			if(window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB)
				showElement('idbHider', true);
			showElement('fSettings',true);
			ENV.XASH3D_GAMEDIR = gamedir;
			ENV.XASH3D_RODIR = '/rodir'
			function loadModule(name)
			{
				var script = document.createElement('script');
				script.onload = function(){moduleCount++;if(moduleCount==3){Module.setStatus("Scripts downloaded!");}};
				document.body.appendChild(script);
				script.src = name + ".js";
			}
			loadModule("server");
			loadModule("client");
			loadModule("menu");
		}
		Module.preInit = [skipRun];
		Module.websocket = [];
		Module.websocket.url = 'wsproxy://127.0.0.1:3000/'
		ENV = [];

		</script>

		{{{ SCRIPT }}}

	</body>
</html>
